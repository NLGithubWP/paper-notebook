Paxos Made Moderately Complex

# Question of Implementation of Paxos

1. Each operation requires 2 rounds of communications
2. which proxy instance the client should send to 
3. The gap of the log, eg, many requests come to Paxos instance, each request will trigger 2 rounds of communications.  When the late request comes, the previous may still not reach consensus. 
4. How to elect a distinguished proposer.

# PMMC

## High-level idea

Leader elects itself by running Paxos Phase 1 for all instances. 

Once elected, only runs Paxos Phase 2 for each proposal

If the leader dies, other nodes repeat the process (elect themselves, etc.)

## Roles

### Client

the client talks to the leader / replica, sends leader messages.

### Leader

- Elected proposer
- One elected, start 2 phase communication.
- Each proposal is defined `ballots = (LeaderId, SeqNum)`, (1, 0) > (0, 2) > (0, 1)

### Acceptor

- the same as Paxos acceptor
- Only accept prepare request with `bigger ballots`
- Only accept values from the current ballot.

![image-20220304205212266](imgs/image-20220304205212266.png)

### Replicas

- Like learners, keep logs of operations. 
- `The client can talk to replica, and replica sends operations to leaders.` 

## Progress

### 1. Leader selection

**Election time**

- Once the proposer starts
- When the current active leader seems to fail. (Not receive heartbeat)
- If a leader is preempted, don't immediately try for election again.

**Election process**

- Proposer broadcast the Prepare Message with the current ballot.
- Acceptor act as in Paxos.

### 2. Replica's logs

- Each replica maintains a log, where each slot has a ballot.

- Maintain 2 pointers, one is a slot-out pointer, another is a slot-in pointer.

  - `slot-out pointer: Point to the next message to be chosen.`

    `Slot-out ensure all operations before it is chosen.` 

  - `Slot-in pointer: Point to the position where the proposer wants to propose next.`

### 3. Proposal consensus

- The client sends an operation to `all replicas or one replica`, the replica record the operation to a slot of the local log. 

- Replica then sends the operation to the leader.
- The leader sends the operation to acceptors to reach a consensus.
- Once the operation reaches consensus, the Leader broadcasts to all other replicas.
- And then the replica receives the operation and then the slot_out pointer moves in.
- Once slot_out moves in, it's safe to execute it. 

Notice: 

The operation can be out of order. eg, Op4 is decided, but Op3 is still not decided.  `But in this situation, slot_out still stay at the current position`

If the new decided value is not the same as the current value, propose the current value in the next proposal round. 

![image-20220304220414008](imgs/image-20220304220414008.png)

## 